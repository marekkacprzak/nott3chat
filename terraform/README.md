# NotT3Chat Azure Infrastructure

This Terraform configuration creates the Azure infrastructure for the NotT3Chat application with proper security configurations.

## Architecture

The infrastructure includes:
- **Resource Group**: Container for all resources
- **Key Vault**: Secure storage for secrets (JWT keys, API keys)
- **Storage Account**: File storage for SQLite database at `/mnt/azurefileshare/database.dat`
- **App Service**: Linux container web app from `hubchat.azurecr.io/nott3chat-backend:latest`
- **Static Web App**: Frontend hosting
- **Application Insights**: Monitoring and telemetry

## Prerequisites

1. Azure CLI installed and authenticated
2. Terraform >= 1.0 installed
3. Docker container `hubchat.azurecr.io/nott3chat-backend:latest` available

## Usage

### 1. Initialize Terraform

```bash
cd terraform
terraform init
```

### 2. Configure Variables

```bash
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your values
```

### 3. Plan and Apply

```bash
terraform plan
terraform apply
```

### 4. Get Deployment Token

After successful apply, get the Static Web App deployment token:

```bash
terraform output -raw static_web_app_deployment_token
```

### 5. Deploy Frontend

Use the deployment token with Azure Static Web Apps CLI:

```bash
npx @azure/static-web-apps-cli deploy --deployment-token="<token_from_step_4>"
```

## Module Structure

```
modules/
├── resource-group/      # Azure Resource Group
├── key-vault/          # Azure Key Vault with secrets
├── storage-account/    # Azure Storage with file share
├── app-service/        # Azure App Service (Linux container)
├── static-web-app/     # Azure Static Web Apps
└── application-insights/ # Azure Application Insights
```

## Security Features

- **HTTPS Only**: App Service configured for HTTPS-only
- **Managed Identity**: App Service uses managed identity for Key Vault access
- **Secure Secrets**: All secrets stored in Key Vault
- **File Storage**: SQLite database persisted in Azure File Share
- **Application Insights**: Monitoring and logging enabled

## Outputs

- `backend_url`: Backend App Service URL
- `frontend_url`: Frontend Static Web App URL
- `static_web_app_deployment_token`: Token for frontend deployment
- `key_vault_name`: Key Vault name for secret management
- Resource names for management

## Backend Configuration

The backend App Service is configured with:
- Container: `hubchat.azurecr.io/nott3chat-backend:latest`
- File mount: `/mnt/azurefileshare` for SQLite database
- Database path: `/mnt/azurefileshare/database.dat`
- Environment variables:
  - `ASPNETCORE_ENVIRONMENT=Production`
  - `ConnectionStrings__DefaultConnection=Data Source=/mnt/azurefileshare/database.dat`
  - `WebUrl` = Static Web App URL (for CORS)
  - `Jwt__SecretKey` = Key Vault reference
  - `APPLICATIONINSIGHTS_CONNECTION_STRING` = Application Insights

## Cleanup

```bash
terraform destroy
```

## Notes

- The SQLite database file will be created automatically when the backend container starts
- The Storage Account name is generated by removing hyphens from namespace_name + "storage"
- Key Vault secrets are auto-generated if not provided
- Managed identity provides secure access between services